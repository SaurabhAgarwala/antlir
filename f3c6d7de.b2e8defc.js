(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{170:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return p})),n.d(t,"default",(function(){return c}));var a=n(2),r=n(10),o=(n(0),n(173)),i={id:"overview",title:"Overview"},l={id:"concepts/rpms/overview",isDocsHomePage:!1,title:"Overview",description:"RPMs come from snapshots",source:"@site/docs/concepts/rpms/overview.md",permalink:"/antlir/docs/concepts/rpms/overview",editUrl:"https://github.com/facebookincubator/antlir/edit/master/website/docs/concepts/rpms/overview.md",sidebar:"docs",previous:{title:"Version Selection",permalink:"/antlir/docs/concepts/rpms/version-selection"},next:{title:".bzl and TARGETS",permalink:"/antlir/docs/contributing/coding-conventions/bzl-and-targets"}},p=[{value:"RPMs come from snapshots",id:"rpms-come-from-snapshots",children:[{value:"Where&#39;s the code?",id:"wheres-the-code",children:[]}]},{value:"When are snapshots updated?",id:"when-are-snapshots-updated",children:[{value:"I have a SEV and need RPM <code>xyz-1.2.3</code> in my image RIGHT NOW",id:"i-have-a-sev-and-need-rpm-xyz-123-in-my-image-right-now",children:[]},{value:"(For <code>twimage</code> team members only) Manual snapshot update",id:"for-twimage-team-members-only-manual-snapshot-update",children:[]},{value:"Manually updating the build appliance",id:"manually-updating-the-build-appliance",children:[]}]},{value:"FAQ",id:"faq",children:[{value:"My RPM exists in the repos, but fails to install from my <code>TARGETS</code> file",id:"my-rpm-exists-in-the-repos-but-fails-to-install-from-my-targets-file",children:[]}]}],s={rightToc:p};function c(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"rpms-come-from-snapshots"},"RPMs come from snapshots"),Object(o.b)("p",null,"When you specify an RPM name in a Buck image specification, it does ",Object(o.b)("strong",{parentName:"p"},"not")," come\ndirectly from the production Yum repos. Instead, it is fetched from a repo\nsnapshot that is provided by your current checkout of FBCode."),Object(o.b)("h3",{id:"wheres-the-code"},"Where's the code?"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Concurrent snapshots coordinate via\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://our.intern.facebook.com/intern/db/shards_replicasets/xdb.rpm_repos/"}),"xdb.rpm_repos"),",\nrun ",Object(o.b)("inlineCode",{parentName:"p"},"db xdb.rpm_repos")," for SQL queries")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Blob data (RPM files, repodata files) are in the\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://our.intern.facebook.com/intern/manifold/bucket-view/?bucket_name=rpm_repos&show_keys=0"}),"Manifold bucket rpm_repos"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Repo snapshotter & historical repo server:\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://phabricator.intern.facebook.com/diffusion/FBS/browse/master/fbcode/antlir/rpm"}),"fbcode/antlir/rpm/"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"The manifold ID of the latest repo snapshot, plus scripts to generate and\ncommit a new snapshot:\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://our.intern.facebook.com/intern/diffusion/FBS/browse/master/fbcode/antlir/rpm/facebook/fb_centos7"}),"CentOS7"),"\nand\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://our.intern.facebook.com/intern/diffusion/FBS/browse/master/fbcode/antlir/rpm/facebook/fb_centos8"}),"CentOS8"),".\nInspect the snapshot via (e.g. for CentOS7):"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),'sqlite3 file:"$(readlink -f "$(\n   buck build //antlir/rpm/facebook:fb_centos7 --show-full-output |\n   cut -f 2 -d \' \'\n)")"/snapshot/snapshot.sql3?mode=ro``\n')),Object(o.b)("p",{parentName:"li"},"For example, you can get stats on RPM errors via this query:"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),'SELECT "error", COUNT(1) FROM "rpm" WHERE "error" IS NOT NULL GROUP BY "error";\n')),Object(o.b)("p",{parentName:"li"},'As another example, let\'s see which versions of "netperf" rpm are available:'),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),'SELECT * from "rpm" WHERE "name" IS "netperf";\n')))),Object(o.b)("h2",{id:"when-are-snapshots-updated"},"When are snapshots updated?"),Object(o.b)("p",null,"We automatically update snapshots on a roughly daily cadence, but this can\nsometimes be delayed due to infrastructure issues. See\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.internalfb.com/intern/wiki/Tupperware/Engineering/Images/Internal_Automation/Automatic_Repo_Updates/"}),"Automatic Repo Updates"),"."),Object(o.b)("h3",{id:"i-have-a-sev-and-need-rpm-xyz-123-in-my-image-right-now"},"I have a SEV and need RPM ",Object(o.b)("inlineCode",{parentName:"h3"},"xyz-1.2.3")," in my image RIGHT NOW"),Object(o.b)("p",null,"Don't despair, just follow these easy steps to clowntown:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Put the relevant RPM in ",Object(o.b)("inlineCode",{parentName:"li"},"tupperware/image/your_team"),", next to your image's\n",Object(o.b)("inlineCode",{parentName:"li"},"TARGETS")," file."),Object(o.b)("li",{parentName:"ul"},"Add ",Object(o.b)("inlineCode",{parentName:"li"},'"image.source("xyz-1.2.3.rpm")')," (this implicitly creates an\n",Object(o.b)("inlineCode",{parentName:"li"},"export_file")," target) in your layer's RPMs list.")),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Note:")," If you need to ",Object(o.b)("strong",{parentName:"p"},"commit")," a large RPM to fbcode instead of doing a\none-off sandbox hotfix, you should:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Put your RPM into an :fbFbpkg \\<Fbpkg",">"," and tag it, - add the fbpkg to the\nFBCode fbpkg DB via\n",Object(o.b)("inlineCode",{parentName:"li"},"buck run antlir/fbpkg/facebook/db:update-db -- --db antlir/fbpkg/facebook/db/main_db/ --create YOUR_PKG YOUR_TAG '{}'")),Object(o.b)("li",{parentName:"ul"},"use\n",Object(o.b)("inlineCode",{parentName:"li"},"image.source(fbpkg.fetched_layer('YOUR_PKG', 'YOUR_TAG'), path='your.rpm')"),"\nin your list of ",Object(o.b)("inlineCode",{parentName:"li"},"rpms"),", and you will install that specific RPM from your\nFbpkg.")),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Note2:")," Having the versions in the TARGETS file and in the fbpkg makes it\nsignificantly harder to update the versions. Specifically, you have to:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"update & commit change to Configerator"),Object(o.b)("li",{parentName:"ul"},"update the TARGETS file"),Object(o.b)("li",{parentName:"ul"},"preserve a new fbpkg with the new versions"),Object(o.b)("li",{parentName:"ul"},"manually run update-db"),Object(o.b)("li",{parentName:"ul"},"commit all of the above as one diff"),Object(o.b)("li",{parentName:"ul"},"tag the fbpkg")),Object(o.b)("p",null,"In contrast, following the example of systemd in\n",Object(o.b)("inlineCode",{parentName:"p"},"tupperware/image/base/os/TARGETS"),", you have a 1.5-step approach:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"preserve and tag the new fbpkg"),Object(o.b)("li",{parentName:"ul"},"wait for automation to commit it")),Object(o.b)("h3",{id:"for-twimage-team-members-only-manual-snapshot-update"},"(For ",Object(o.b)("inlineCode",{parentName:"h3"},"twimage")," team members only) Manual snapshot update"),Object(o.b)("p",null,"Snapshots are performed automatically, and should ideally be the only things\nproducing RPM repo updates. However, if for some reason you need to manually\nsnapshot, follow the steps below."),Object(o.b)("p",null,"The strategy is to use the same script that's run by our automation,\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://our.intern.facebook.com/intern/diffusion/FBS/browse/master/fbcode/antlir/rpm/facebook/snapshot_and_upload.py"}),"seen here"),"."),Object(o.b)("p",null,"A snapshot run on your devserver is likely to complete much faster compared to\nthose running in Sandcastle, and, as long as a previous snapshot has been\ncompleted within the past few days, should take on the order of an hour."),Object(o.b)("p",null,"To kick off a snapshot, simply run\n",Object(o.b)("inlineCode",{parentName:"p"},"buck run //antlir/rpm/facebook/chronos:snapshot-and-upload"),"."),Object(o.b)("p",null,"This script will publish a commit including everything neeeded to\npublish a repo update. With this diff:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Make sure that contbuild is green. If not, investigate, and get help\nfrom the owning team."),Object(o.b)("li",{parentName:"ul"},"Ship the diff")),Object(o.b)("h3",{id:"manually-updating-the-build-appliance"},"Manually updating the build appliance"),Object(o.b)("p",null,'Image builds do not use RPM snapshots directly, rather, they need the snapshot\nto be included into the "build appliance" image, which collects tools and data\nrequired to build images.'),Object(o.b)("p",null,"The above ",Object(o.b)("inlineCode",{parentName:"p"},"snapshot_and_upload")," script should manually create and upload a new\nbuild appliance. If for some reason you need to do this manually, you can simply\nrun:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),"buck run @mode/opt //tupperware/image/build_appliance:tupperware.image.sendstream.build_appliance\n")),Object(o.b)("p",null,"Next, take the ephemeral UUID that's printed and run:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),'buck run //antlir/fbpkg/facebook/db:update-db -- \\\n    --db "$(hg root)/fbcode/do-not-build/antlir/fbpkg/facebook/db/repo_tag_db/" \\\n    --no-update-existing \\\n    --replace tupperware.image.sendstream.build_appliance repo_stable \\\n    \'{"uuid": "UUID", "allow_ephemeral": true, "auto_preserve": true}\'\n')),Object(o.b)("h2",{id:"faq"},"FAQ"),Object(o.b)("h3",{id:"my-rpm-exists-in-the-repos-but-fails-to-install-from-my-targets-file"},"My RPM exists in the repos, but fails to install from my ",Object(o.b)("inlineCode",{parentName:"h3"},"TARGETS")," file"),Object(o.b)("p",null,"Troubleshooting steps (using CentOS7 as an example, though this also\napplies to CentOS8):"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Did you specify your RPM name correctly? Remember that ",Object(o.b)("inlineCode",{parentName:"p"},"foo-project")," is OK,\nbut ",Object(o.b)("inlineCode",{parentName:"p"},"foo-project-1.12"),' is not supported. We will eventually support version\nlocking, but it will never use the RPM string syntax. For now, see "I have a\nSEV" above.')),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Does the repo snapshot in ",Object(o.b)("inlineCode",{parentName:"p"},"antlir/rpm/facebook/fb_centos7/")," include your\nRPM? Replace ",Object(o.b)("inlineCode",{parentName:"p"},"gimp")," with your RPM and run:"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-{.sourceCode",metastring:".sh}",".sh}":!0}),'echo \'SELECT "repo", "path" FROM "rpm" WHERE "name" = "gimp";\' |\nsqlite3 file:"$(readlink -f "$(\nbuck build //antlir/rpm/facebook:fb_centos7 --show-full-output |\n   cut -f 2 -d \' \'\n)")"/snapshot.sql3?mode=roo\n')))),Object(o.b)("p",null,"If both steps above check out, the most likely cause is ",Object(o.b)("inlineCode",{parentName:"p"},"mutable_rpm")," errors.\nFor certain RPMs, human error has resulted in our repos having multiple copies\nRPM with ",Object(o.b)("strong",{parentName:"p"},"different content")," but the same name. See\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://fb.prod.workplace.com/groups/prodos.users/permalink/2612322622149670/"}),"this post"),"\nfor more info."),Object(o.b)("p",null,"Since this is inherently broken, we disallow installing such RPMs from Buck."),Object(o.b)("p",null,"If you see encounter this, you will want to:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Ping the OS team to remove the bad copy of the RPM, mentioning\n",Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://fb.prod.workplace.com/groups/prodos.users/permalink/2612322622149670/"}),"this thread"),"\nfor context."),Object(o.b)("li",{parentName:"ul"},"The OS team deletes the bad RPM that affects you (or ideally all!)."),Object(o.b)("li",{parentName:"ul"},"Ping the ",Object(o.b)("inlineCode",{parentName:"li"},"twimage")," team, who will add the ",Object(o.b)("em",{parentName:"li"},"deleted")," RPM to\n",Object(o.b)("inlineCode",{parentName:"li"},"facebook/deleted_mutable_rpms.py")," and re-run the RPM snapshot for you."),Object(o.b)("li",{parentName:"ul"},'Once you rebase, the "mutable_rpm" error should disappear and your RPM\nshould install.')),Object(o.b)("p",null,"Note that as of November 2019, there is a firm intention to eliminate and\nprevent ",Object(o.b)("inlineCode",{parentName:"p"},"mutable_rpm")," errors. Details in the comments on\n",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://fb.prod.workplace.com/groups/prodos.users/permalink/3009954169053178/"}),"this post"),"."))}c.isMDXComponent=!0},173:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return d}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=r.a.createContext({}),c=function(e){var t=r.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=c(e.components);return r.a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},m=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),b=c(n),m=a,d=b["".concat(i,".").concat(m)]||b[m]||u[m]||o;return n?r.a.createElement(d,l(l({ref:t},s),{},{components:n})):r.a.createElement(d,l({ref:t},s))}));function d(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=m;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:a,i[1]=l;for(var s=2;s<o;s++)i[s]=n[s];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);